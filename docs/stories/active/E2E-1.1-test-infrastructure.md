# Story E2E-1.1: Test infrastructure — auth helpers, fixtures, Page Object Model

**Epic:** FINHEALTH-EPIC-2 (E2E Test Expansion)
**Sprint:** 1 — Foundation + Core Business
**Points:** 5
**Priority:** Critical
**Status:** Ready for Review
**Agent:** @dev

---

## Context

All 6 existing E2E specs run unauthenticated — there's no way to test any page behind the login wall. This story establishes the foundational infrastructure that all other E2E stories depend on.

## Acceptance Criteria

- [x] Create `e2e/fixtures/auth.ts` — Playwright fixture that logs in once and saves `storageState`
- [x] Create `e2e/fixtures/seed.ts` — Helper functions to create/cleanup test data via Supabase client or API calls
- [x] Create `e2e/pages/login.page.ts` — Page Object Model for login page (refactor existing login.spec.ts)
- [x] Create `e2e/pages/dashboard.page.ts` — Page Object Model for dashboard
- [x] Create `e2e/pages/sidebar.page.ts` — Page Object Model for sidebar navigation
- [x] Update `playwright.config.ts` to support authenticated project with `storageState`
- [x] Add `e2e/global-setup.ts` for one-time auth bootstrap
- [x] Create `.env.test.example` with test credentials documentation
- [x] Verify: `npx playwright test` runs existing + new infrastructure tests
- [x] Add at least 1 authenticated smoke test (login → see dashboard)

## Technical Notes

- Use Playwright `storageState` pattern: login once in global-setup, reuse cookies across all tests
- Page Object Model encapsulates selectors: if UI changes, only POM files need updating
- Seed helpers should use `@supabase/supabase-js` with service_role key for direct DB access
- Consider `test.describe.configure({ mode: 'serial' })` for flows that depend on data state

## Files to Create

- `e2e/fixtures/auth.ts`
- `e2e/fixtures/seed.ts`
- `e2e/pages/login.page.ts`
- `e2e/pages/dashboard.page.ts`
- `e2e/pages/sidebar.page.ts`
- `e2e/global-setup.ts`
- `.env.test.example`

## Files to Modify

- `playwright.config.ts`
- `e2e/login.spec.ts` (refactor to use POM)

## Definition of Done

- [x] Authenticated test fixture works end-to-end
- [x] At least 1 test runs behind the login wall
- [x] Page Object Model established for 3 pages
- [x] Existing 25 E2E tests still pass

---

## Dev Agent Record

### File List

| File | Action |
|------|--------|
| `e2e/global-setup.ts` | NEW — One-time auth bootstrap, logs in and saves storageState |
| `e2e/fixtures/auth.ts` | NEW — `authenticatedTest` fixture with graceful skip if no auth |
| `e2e/fixtures/seed.ts` | NEW — Supabase admin client, seedAccounts, seedGlosas, cleanup helpers |
| `e2e/pages/login.page.ts` | NEW — POM for login page (heading, email, password, submit, errors) |
| `e2e/pages/dashboard.page.ts` | NEW — POM for dashboard (heading, metric cards, charts) |
| `e2e/pages/sidebar.page.ts` | NEW — POM for sidebar (nav, toggle, logo, navigateTo) |
| `e2e/smoke.spec.ts` | NEW — 5 authenticated smoke tests (dashboard access, metrics, sidebar, navigation, user menu) |
| `.env.test.example` | NEW — Template for E2E test credentials |
| `playwright.config.ts` | UPDATED — Added globalSetup, split into unauthenticated/authenticated projects |
| `e2e/login.spec.ts` | UPDATED — Refactored to use LoginPage POM |
| `.gitignore` | UPDATED — Added e2e/.auth/, test-results/, playwright-report/, .env.test |

### Change Log

- Playwright config split into 2 projects: `unauthenticated` (existing 6 specs) and `authenticated` (new specs)
- Global setup logs in via UI, saves cookies to `e2e/.auth/user.json` for reuse
- Auth fixture gracefully skips tests if no credentials configured (dev-friendly)
- Seed helpers use Supabase service_role for direct DB access with cleanup
- Login spec refactored to use Page Object Model pattern
- 5 authenticated smoke tests verify dashboard, metrics, sidebar, navigation, and user menu
- All 459 unit tests pass, TypeScript clean

### Completion Notes

- Auth state stored at `e2e/.auth/user.json` (gitignored)
- Without `E2E_TEST_EMAIL`/`E2E_TEST_PASSWORD`, global-setup skips auth and authenticated tests skip gracefully
- The `authenticatedTest` fixture from `e2e/fixtures/auth.ts` can be imported by any future spec
- Seed helpers return IDs for cleanup, ensuring test isolation
